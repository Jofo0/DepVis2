import { useLazyGetVulnerabilityQuery } from "@/store/api/projectsApi";
import type { VulnerabilitySmallDto } from "@/types/vulnerabilities";
import { useEffect } from "react";
import SimpleGraph from "./graph/SimpleGraph";
import { Card, CardHeader, CardContent } from "./ui/card";
import { useBranch } from "@/utils/hooks/BranchProvider";
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from "@/components/ui/accordion";
import { ExternalLink } from "lucide-react";

type VulnerabilityCardProps = {
  selectedVulnerability: VulnerabilitySmallDto | null;
};

const VulnerabilityCard = ({
  selectedVulnerability,
}: VulnerabilityCardProps) => {
  const { branch } = useBranch();

  const [fetchVulnerability, { data: vulnData, isFetching: isLoadingVuln }] =
    useLazyGetVulnerabilityQuery();

  useEffect(() => {
    if (selectedVulnerability) {
      fetchVulnerability(selectedVulnerability.vulnerabilityId);
    }
  }, [selectedVulnerability, fetchVulnerability]);

  const items = [
    {
      value: "item-1",
      trigger: "Vulnerability Information",
      content: (
        <div className="flex flex-col gap-2">
          <p className="w-full flex flex-row justify-between border-b-2 items-center">
            <div className="text-lg">Severity:</div>
            {vulnData?.severity}
          </p>
          <p className="w-full flex flex-row justify-between border-b-2 items-center">
            <div className="text-lg">CWEs:</div>
            <div className="flex flex-row gap-0.5">
              {vulnData?.cwes.map((cwe) => (
                <a href={`https://cwe.mitre.org/data/definitions/${cwe}.html`}>
                  {cwe}
                </a>
              ))}
            </div>
          </p>
          <p className="w-full flex flex-row justify-between border-b-2 items-center">
            <div className="text-lg">Remediation:</div>
            {vulnData?.recommendation}
          </p>
        </div>
      ),
    },
    {
      value: "item-5",
      trigger: "Vulnerability Description",
      content: <div>{vulnData?.description}</div>,
    },
    {
      value: "item-3",
      trigger: "Vulnerability Graph",
      content: (
        <div className="max-h-[12rem] max-w-[55rem] h-[12rem] w-[55rem]">
          <SimpleGraph
            lr
            showNames={"severity"}
            branch={branch!}
            packageId={selectedVulnerability?.packageId}
          />
        </div>
      ),
    },
    {
      value: "item-4",
      trigger: "Vulnerability References",
      content: (
        <div className="flex flex-col gap-1">
          {vulnData?.references.map((reference) => (
            <div>
              <a
                href={reference}
                target="_blank"
                rel="noreferrer"
                className="inline-flex items-center gap-1 text-primary underline-offset-4 hover:underline"
              >
                {reference}
                <ExternalLink className="h-4 w-4 opacity-70" />
              </a>
            </div>
          ))}
        </div>
      ),
    },
  ];
  return (
    <Card
      className={`overflow-hidden border-3 self-center ${
        selectedVulnerability
          ? "h-full w-full max-w-full"
          : "h-1/6 w-1/3 m-3.5 border-dashed "
      } transition-all duration-500 ease-in-out`}
    >
      {selectedVulnerability ? (
        <>
          {isLoadingVuln ? (
            <CardHeader>Loading vulnerability details...</CardHeader>
          ) : (
            <>
              <CardHeader>
                {isLoadingVuln
                  ? "Loading Vulnerability..."
                  : `Vulnerability: ${vulnData?.id}`}
              </CardHeader>
              <CardContent className="text-lg">
                <Accordion type="single" collapsible defaultValue="item-1">
                  {items.map((item) => (
                    <AccordionItem key={item.value} value={item.value}>
                      <AccordionTrigger>{item.trigger}</AccordionTrigger>
                      <AccordionContent>{item.content}</AccordionContent>
                    </AccordionItem>
                  ))}
                </Accordion>
              </CardContent>
            </>
          )}
        </>
      ) : (
        <div className="flex items-center justify-center h-full">
          <p>Select a Vulnerability to see more details</p>
        </div>
      )}
    </Card>
  );
};

export default VulnerabilityCard;
