import { useLazyGetVulnerabilityQuery } from "@/store/api/projectsApi";
import type { VulnerabilitySmallDto } from "@/types/vulnerabilities";
import { useEffect } from "react";
import SimpleGraph from "./graph/SimpleGraph";
import { Card, CardHeader, CardContent } from "./ui/card";
import { useBranch } from "@/utils/hooks/BranchProvider";

type VulnerabilityCardProps = {
  selectedVulnerability: VulnerabilitySmallDto | null;
};

const VulnerabilityCard = ({
  selectedVulnerability,
}: VulnerabilityCardProps) => {
  const { branch } = useBranch();

  const [fetchVulnerability, { data: vulnData, isFetching: isLoadingVuln }] =
    useLazyGetVulnerabilityQuery();

  useEffect(() => {
    if (selectedVulnerability) {
      fetchVulnerability(selectedVulnerability.vulnerabilityId);
    }
  }, [selectedVulnerability, fetchVulnerability]);

  return (
    <Card
      className={`overflow-hidden border-3 self-center ${
        selectedVulnerability
          ? "h-full w-full max-h-full max-w-full"
          : "h-1/6 w-1/3 m-3.5 border-dashed "
      } transition-all duration-500 ease-in-out`}
    >
      {selectedVulnerability ? (
        <>
          {isLoadingVuln ? (
            <CardHeader>Loading vulnerability details...</CardHeader>
          ) : (
            <>
              <CardHeader>
                {isLoadingVuln
                  ? "Loading Vulnerability..."
                  : `Vulnerability: ${vulnData?.id}`}
              </CardHeader>
              <CardContent className="text-lg">
                <p>
                  <strong>Severity: </strong>
                  {vulnData?.severity}
                </p>
                <p>
                  <strong>Description: </strong>
                  {vulnData?.description}
                </p>
                <p>
                  <strong>Recommendation: </strong>
                  {vulnData?.recommendation}
                </p>
              </CardContent>
              <div className="max-h-[20rem] max-w-[55rem] m-4">
                <SimpleGraph
                  lr
                  branch={branch!}
                  packageId={selectedVulnerability.packageId}
                />
              </div>
            </>
          )}
        </>
      ) : (
        <div className="flex items-center justify-center h-full">
          <p>Select a Vulnerability to see more details</p>
        </div>
      )}
    </Card>
  );
};

export default VulnerabilityCard;
