using DepVis.Core.Dtos;
using DepVis.Core.Extensions;
using DepVis.Core.Repositories;
using Microsoft.AspNetCore.OData.Query;

namespace DepVis.Core.Services;

public class VulnerabilityService(
    VulnerabilityRepository vulnerabilityRepository,
    PackageRepository packageRepository
)
{
    public async Task<VulnerabilitiesDto> GetVulnerabilities(
        Guid branchId,
        ODataQueryOptions<VulnerabilitySmallDto> odata
    )
    {
        var vulnerabilities = packageRepository
            .GetLatestPackagesForBranch(branchId)
            .SelectMany(
                x => x.Vulnerabilities,
                (x, vuln) =>
                    new VulnerabilitySmallDto
                    {
                        VulnerabilityId = vuln.Id,
                        Severity = vuln.Severity,
                        PackageName = x.Name,
                        PackageId = x.Id,
                    }
            );

        var result = (await odata.ApplyOdata(vulnerabilities)).DistinctBy(x => x.VulnerabilityId);

        return new()
        {
            Vulnerabilities = [.. result],
            Risks =
            [
                .. result
                    .GroupBy(x => x.Severity)
                    .Select(g => new NameCount { Name = g.Key, Count = g.Count() })
                    .OrderBy(x => x.Count),
            ],
        };
    }

    public async Task<VulnerabilityDetailedDto?> GetVulnerability(string vulnId)
    {
        var vuln = await vulnerabilityRepository.GetByIdAsync(vulnId);
        return vuln == null
            ? null
            : new VulnerabilityDetailedDto
            {
                Id = vuln.Id,
                Description = vuln.Description,
                Recommendation = vuln.Recommendation,
                Severity = vuln.Severity,
            };
    }
}
